# Skills Recommendation API — REST API Specification

Service: **skills-recommendation-api**  
App title (FastAPI): **skills_recommendation_api**  
App version: **0.1.0**  
Repository: `skills_recommendation_via_rag`

Purpose:  
Recommend ranked skills for a free-text user query using **hybrid retrieval (FAISS cosine + BM25)** and **LLM-based reasoning** (generation + optional judge), returning a stable API response envelope:

- `payload`: final recommendation payload (skills + reasoning + evidence + meta text/criteria)
- `meta`: traceability metadata (e.g., cache ids)
- `debug`: optional debug info (join stats, counts)

---

## Base URLs

**Production (Cloud Run):**  
https://skills-recommendation-api-810737581373.asia-southeast1.run.app

**Local:**  
http://127.0.0.1:8000

**Swagger / OpenAPI**
- Swagger UI (local): http://127.0.0.1:8000/docs
- OpenAPI JSON (local): http://127.0.0.1:8000/openapi.json
- Swagger UI (prod): https://skills-recommendation-api-810737581373.asia-southeast1.run.app/docs
- OpenAPI JSON (prod): https://skills-recommendation-api-810737581373.asia-southeast1.run.app/openapi.json

---

## Guideline Alignment Notes (Current Implementation)

- ✅ **HTTP method:** `POST` used for execution-style recommendation
- ✅ **Content-Type:** JSON request/response
- ✅ **Swagger/OpenAPI:** auto-generated by FastAPI
- ✅ **Health endpoint:** `GET /healthz`
- ⚠️ **Error envelope:** currently FastAPI `HTTPException(detail=...)` only
- ⚠️ **Correlation ID:** not implemented at API boundary (not required / not echoed)
- ⚠️ **API version header:** not implemented at API boundary

---

## Authentication & Authorization

**Not enforced yet.**  
Cloud Run service currently deployed with `--allow-unauthenticated`.

Future-ready patterns:
- `Authorization: Bearer <token>`
- `X-API-Key: <key>`

---

## Required Headers

### Content-Type
```http
Content-Type: application/json
````

---

## Runtime Configuration (via Environment Variables)

These control which config files the service loads at runtime:

| Env Var            | Default                    | Purpose                                               |
| ------------------ | -------------------------- | ----------------------------------------------------- |
| `PARAMETERS_PATH`  | `configs/parameters.yaml`  | Parameters/config for pipelines                       |
| `CREDENTIALS_PATH` | `configs/credentials.yaml` | Credentials config (model name + secret env var name) |

> Deployment note: On Cloud Run, secrets should be injected as environment variables (e.g. `GEMINI_API_KEY`) using `--set-secrets`.

---

## Endpoints Summary

### Health

* `GET /healthz`

### Skill Recommendation

* `POST /v1/recommend-skills`

---

## 1) Health Endpoint

### GET /healthz

**200 OK**

```json
{
  "status": "ok"
}
```

---

## 2) Skill Recommendation

### POST /v1/recommend-skills

Executes a full skill recommendation request by orchestrating online pipelines:

* Hybrid retrieval context (vector + BM25 merge)
* LLM generation (JSON-only contract validated against runtime schema)
* Optional judge gating (`require_judge_pass`)
* API payload build by joining LLM recs with retrieval meta (skill_id/source/skill_text/criteria)

---

### Request Model (RecommendSkillsRequest)

**JSON body fields (snake_case only):**

| Field                | Type           | Required | Default | Constraints                                | Description                                                                 |
| -------------------- | -------------- | -------: | ------: | ------------------------------------------ | --------------------------------------------------------------------------- |
| `query`              | string         |        ✅ |       — | `min_length=1` + cannot be whitespace-only | User query text, e.g. `"data scientist"`                                    |
| `top_k`              | integer | null |        ❌ |    `20` | `1..100`                                   | Number of merged/context rows for LLM + max output join                     |
| `debug`              | boolean        |        ❌ | `false` | —                                          | Include debug fields in response                                            |
| `require_judge_pass` | boolean        |        ❌ |  `true` | —                                          | If true, run judge and require PASS                                         |
| `top_k_vector`       | integer | null |        ❌ |    `20` | `1..200`                                   | Vector retrieval depth (3a) for 4a/4b/5                                     |
| `top_k_bm25`         | integer | null |        ❌ |    `20` | `1..200`                                   | BM25 retrieval depth (3b) for 4a/4b/5                                       |
| `require_all_meta`   | boolean        |        ❌ | `false` | —                                          | If true, fail when any recommended skill cannot be joined to retrieval meta |

#### Validation Rules

* `query` is stripped; if empty after strip → request fails with validation error.
* Range constraints enforced by Pydantic (422 on invalid values).

---

### Example Request

```json
{
  "query": "data scientist",
  "top_k": 20,
  "debug": true,
  "require_judge_pass": true,
  "top_k_vector": 20,
  "top_k_bm25": 20,
  "require_all_meta": false
}
```

---

## Successful Response (200 OK)

### Response Model (RecommendSkillsResponse)

Top-level response fields:

| Field     | Type          | Required | Description                                |
| --------- | ------------- | -------: | ------------------------------------------ |
| `payload` | object        |        ✅ | Final API payload (recommendations)        |
| `meta`    | object        |        ✅ | Traceability metadata                      |
| `debug`   | object | null |        ❌ | Debug info; present only when `debug=true` |

> FastAPI enforces this response model for `/v1/recommend-skills`.

---

### `payload` object (current runtime contract)

`payload` is produced by Pipeline 5 (API payload builder). It includes:

* `query` (echo)
* `analysis_summary`
* `recommended_skills` (array)

#### payload fields

| Field                | Type          | Required | Notes                 |
| -------------------- | ------------- | -------: | --------------------- |
| `query`              | string        |        ✅ | Echo of request query |
| `analysis_summary`   | string        |        ✅ | LLM-generated summary |
| `recommended_skills` | array[object] |        ✅ | Ranked list           |

#### payload.recommended_skills[*] fields (enriched)

Each recommended skill includes:

* LLM reasoning/evidence/relevance score (from 4b)
* Retrieval meta text (from 4a results join), including criteria blocks when available

| Field                   | Type          | Required | Notes                                            |
| ----------------------- | ------------- | -------: | ------------------------------------------------ |
| `skill_id`              | string        |        ✅ | Canonical id from corpus                         |
| `skill_name`            | string        |        ✅ | Canonical name                                   |
| `source`                | string        |        ✅ | Source tag (e.g., cluster/lightcast/skillfuture) |
| `relevance_score`       | number        |        ✅ | 0.0–1.0                                          |
| `reasoning`             | string        |        ✅ | LLM reasoning (grounded in retrieved context)    |
| `evidence`              | array[string] |        ✅ | Evidence snippets (from retrieved context)       |
| `skill_text`            | string        |        ✅ | Description text from retrieval meta             |
| `Foundational_Criteria` | string | null |        ❌ | Criteria text (if present in corpus/meta)        |
| `Intermediate_Criteria` | string | null |        ❌ | Criteria text (if present in corpus/meta)        |
| `Advanced_Criteria`     | string | null |        ❌ | Criteria text (if present in corpus/meta)        |

> Note: Exact presence of criteria fields depends on the corpus/meta for that skill.
> If `require_all_meta=true`, the service is expected to fail if join cannot provide meta for any recommended skill.

---

### `meta` object (current runtime contract)

`meta` is returned from Pipeline 5 and currently includes:

| Field                 | Type          | Required | Notes                                         |
| --------------------- | ------------- | -------: | --------------------------------------------- |
| `generation_cache_id` | string | null |        ❌ | Cache key for generation (p4b) when available |

Additional fields may be added later (judge_cache_id, retrieval_cache_id, model version, etc.) but are not guaranteed today.

---

### `debug` object (optional)

Returned only when request `debug=true`.

Currently observed fields:

* join statistics (counts)
* number of retrieval rows used

Example:

```json
{
  "join": {
    "num_llm_recs": 6,
    "num_retrieval_rows": 20,
    "num_joined": 6,
    "num_missing_meta": 0
  },
  "num_retrieval_results": 20
}
```

---

### Example Response (200)

```json
{
  "payload": {
    "query": "data scientist",
    "analysis_summary": "The analysis successfully identified ...",
    "recommended_skills": [
      {
        "skill_id": "745_cluster",
        "skill_name": "data science",
        "source": "cluster",
        "relevance_score": 0.98,
        "reasoning": "This is the most direct match ...",
        "evidence": [
          "The interdisciplinary field that utilizes scientific methods..."
        ],
        "skill_text": "The interdisciplinary field that utilizes ...",
        "Foundational_Criteria": "1. ...\n2. ...\n3. ...",
        "Intermediate_Criteria": "1. ...\n2. ...\n3. ...",
        "Advanced_Criteria": "1. ...\n2. ...\n3. ..."
      }
    ]
  },
  "meta": {
    "generation_cache_id": "p4b__..."
  },
  "debug": {
    "join": {
      "num_llm_recs": 6,
      "num_retrieval_rows": 20,
      "num_joined": 6,
      "num_missing_meta": 0
    },
    "num_retrieval_results": 20
  }
}
```

---

## Error Responses

### 422 — Request validation error (FastAPI / Pydantic)

Example (shape is FastAPI default):

```json
{
  "detail": [
    {
      "type": "value_error",
      "loc": ["body", "query"],
      "msg": "Value error, Query cannot be empty or whitespace-only",
      "input": "   "
    }
  ]
}
```

### 500 — Internal server error

Current behavior:

* Any exception inside pipeline execution is caught
* Server logs full stack trace
* Client receives:

```json
{
  "detail": "Internal server error"
}
```

---

## Operational Requirements (Cloud Run)

### Required Runtime Files Inside Container

The online service requires index artifacts at runtime:

* `artifacts/index_store/faiss.index`
* `artifacts/index_store/faiss_meta.jsonl`
* `artifacts/index_store/bm25_corpus.jsonl`
* `artifacts/index_store/bm25_stats.json`
* `artifacts/index_store/manifest.json`

These must be included in the build context (e.g., via `.gcloudignore` allowlist), otherwise the service will error at runtime with:

* `FileNotFoundError: FAISS index not found: /app/artifacts/index_store/faiss.index`

### Required Secrets

* `GEMINI_API_KEY` (injected as env var via Secret Manager)

---

## Change Log (Consolidated)

### 2026-02-25 — Initial FastAPI + Cloud Run deployment

* Added FastAPI app with:

  * `GET /healthz`
  * `POST /v1/recommend-skills`
* Request schema implemented as `RecommendSkillsRequest`
* Response schema implemented as `RecommendSkillsResponse`
* Cloud Run deployment verified end-to-end with real call returning enriched skill payload
* Deployment hardening: `.gcloudignore` updated to ship `artifacts/index_store/**` into image

---

## Planned / Pending

* Standardized error envelope (code/message/subErrors/timestamp/correlationId)
* Correlation ID header support (`X-Correlation-Id`)
* API version header support (`X-API-Version`)
* Authentication enforcement (JWT / API key)
* Rate limiting and quota controls (gateway layer)
